{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evaluation Options</title>
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">

    <script>
        let currentLineData = {};

        function showText(option) {
            // Hide all text containers
            document.querySelectorAll('.box').forEach(box => box.classList.add('hidden'));
            // Show the selected text container
            const selectedBox = document.getElementById(option);
            selectedBox.classList.remove('hidden');

            // If Option 1, fetch a random line
            if (option === 'option1') {
                const summaryButton = document.getElementById('summary-button');
                summaryButton.innerText = "Try Our Summary"
                const exp_res_display = document.getElementById('exp_res');
                exp_res_display.innerHTML = ``;
                const option1Paragraph = document.getElementById('option1-text'); // Target the specific <p> by id
                option1Paragraph.innerText = 'Loading...'; // Provide feedback while fetching
                fetch('/get-random-line/')
                    .then(response => response.json())
                    .then(data => {
                        option1Paragraph.innerText = JSON.stringify(data.line, null, 2) || 'No data found.';
                        currentLineData = data.line;
                        const idParts = data.line.id.split('-');
                        const story_id = idParts[2];
                        const option1story = document.getElementById('option1-story');
                        fetch(`/get-file-content/${idParts[0]}/${story_id}/`)
                            .then(response => response.json())
                            .then(data => {
                                if (data.file_content) {
                                    document.getElementById('option1-story').innerText = data.file_content;
                                } else {
                                    document.getElementById('option1-story').innerText = 'File not found or could not be read.';
                                }
                            })
                            .catch(error => {
                                console.error('Error fetching file content:', error);
                                document.getElementById('option1-story').innerText = 'An error occurred while fetching the file content.';
                            });
                        option1story.innerText = `${story_id}` || 'No story found';
                    })
                    .catch(error => {
                        console.error('Error fetching data:', error);
                        option1Paragraph.innerText = 'Error fetching data.';
                    });
                    const summaryDisplay = document.getElementById('summary');
                    summaryDisplay.innerHTML = `<textarea id="user-answer" rows="4" cols="250" placeholder="Type your answer here..."></textarea>`;

            }
            if (option === 'option2') {
                const options = document.querySelectorAll('.option');
                options.forEach(option => option.classList.remove('selected'));
                fetch('/get-random-nli/')
                    .then(response => response.json())
                    .then(data => {
                        const option2premise = document.getElementById('option2-premise');
                        option2premise.innerText = `${data.line.sentence1}` || 'No premise found';
                        const option2hypothesis = document.getElementById('option2-hypothesis');
                        option2hypothesis.innerText = `${data.line.sentence2}` || 'No hypothesis found';
                    })
                    .catch(error => {
                        console.error('Error fetching data:', error);
                        option1Paragraph.innerText = 'Error fetching data.';
                    });
            }
            if (option === 'option3') {
                const options = document.querySelectorAll('.option2');
            options.forEach(option => option.classList.remove('selected'));
                fetch('/get-pairwise/')
                    .then(response => response.json())
                    .then(data => {
                        const question = document.getElementById('question');
                        question.innerText = `${data.line.question}` || 'No question found';
                        const model1 = document.getElementById('model1');
                        model1.innerText = `${data.line.model_a}` || 'No model 1 found';
                        const answer1 = document.getElementById('answer1');
                        answer1.innerText = `${data.line.answer_a}` || 'No answer 1 found';
                        const model2 = document.getElementById('model2');
                        model2.innerText = `${data.line.model_b}` || 'No model 2 found';
                        const answer2 = document.getElementById('answer2');
                        answer2.innerText = `${data.line.answer_b}` || 'No answer 2 found';
                    })
                    .catch(error => {
                        console.error('Error fetching data:', error);
                        option1Paragraph.innerText = 'Error fetching data.';
                    });
            }
        }
        function displaySummary() {
    const summaryDisplay = document.getElementById('summary');
    const summaryButton = document.getElementById('summary-button');
    
    // Check the current state of the button
    if (summaryButton.innerText === "Try Our Summary") {
        // Change button text
        summaryButton.innerText = "Type your own summary";

        // Extract summary from current JSON line data
        const summary = currentLineData.decoded || 'No summary available.';
        const exp_res = currentLineData.expert_annotations || 'No expert scores available';
        const exp_res1 = exp_res[0];
        const exp_res2 = exp_res[1];
        const exp_res3 = exp_res[2];
        const coherence = (exp_res1.coherence+exp_res2.coherence+exp_res3.coherence)/3;
        const consistency = (exp_res1.consistency+exp_res2.consistency+exp_res3.consistency)/3;
        const fluency = (exp_res1.fluency+exp_res2.fluency+exp_res3.fluency)/3;
        const relevance = (exp_res1.relevance+exp_res2.relevance+exp_res3.relevance)/3;
        // Display the summary in the div
        summaryDisplay.style.display = 'block';
        summaryDisplay.innerHTML = `<h3>Summary:</h3> <p>${summary}</p>`;
        const exp_res_display = document.getElementById('exp_res');
        exp_res_display.innerHTML = `<h3>Expert scores:</h3> <p> coherence: ${coherence}, consistency: ${consistency}, fluency: ${fluency}, relevance: ${relevance} </p>`;
    } else {
        // Revert the button text
        summaryButton.innerText = "Try Our Summary";

        // Restore the textarea for user's own summary
        summaryDisplay.innerHTML = `<textarea id="user-answer" rows="4" cols="250" placeholder="Type your answer here..."></textarea>`;
        const exp_res_display = document.getElementById('exp_res');
        exp_res_display.innerHTML = ``;
   
    }
}
    function selectOption(selectedElement) {
            // Remove 'selected' class from all options
            const options = document.querySelectorAll('.option');
            options.forEach(option => option.classList.remove('selected'));

            // Add 'selected' class to the clicked element
            selectedElement.classList.add('selected');
        }
        function selectOption2(selectedElement) {
            // Remove 'selected' class from all options
            const options = document.querySelectorAll('.option2');
            options.forEach(option => option.classList.remove('selected'));

            // Add 'selected' class to the clicked element
            selectedElement.classList.add('selected');
        }
        function chooseRandomOption() {
            const options = document.querySelectorAll('.option');
            options.forEach(option => option.classList.remove('selected'));
            const randomIndex = Math.floor(Math.random() * options.length);
            selectOption(options[randomIndex]);
        }
        function chooseRandomOption2() {
            const options = document.querySelectorAll('.option2');
            options.forEach(option => option.classList.remove('selected'));
            const randomIndex = Math.floor(Math.random() * options.length);
            selectOption(options[randomIndex]);
        }
    </script>

</head>
<body>
    <header>
        LLM-Evaluator
    </header>
    <main>
        <h1>Select an Evaluation Type</h1>
        <button onclick="showText('option1')">Point Evaluation (Summary)</button>
        <button onclick="showText('option2')">Pass/Fail Evaluation (NLI)</button>
        <button onclick="showText('option3')">Pairwise Evaluation</button>

        <div id="option1" class="box hidden">
            <h2>Point Evaluation</h2>
            <p>In this task our evaluator gives a score on a story summary's coherence, consistency, fluency, and relevance. </p>
            <div class="styled-box">
                <h3>Story:</h3>
                <p id="option1-story">Loading...</p>
                <button onclick="showText('option1')">Generate a different story</button>

            </div>
            <div id="summary">
                <textarea id="user-answer" rows="4" cols="250" placeholder="Type your answer here..."></textarea>
            </div>
            <p id="exp_res"></p>
            <button id="summary-button" onclick="displaySummary()">Try Our Summary</button>
            
            <p id="option1-text" class="box hidden">Loading...</p> 
        </div>
        
        <div id="option2" class="box hidden">
            <h2>Pass/Fail Evaluation</h2>
            <p>In this task our evaluator gives a passing or a failing score on an NLI problem. Two sentences (a premise and a hypothesis) are given and a relationship between them is determined. It can be entailment where the second sentence can be logically inferred from the first one, contradiction where the second sentence clearly negates the information from the first one, or neutral where neither happens. Our evaluator does not perform the task, but evaluates whether the label given is correct or incorrect.</p>
            <div class="styled-box">
                <h3>Premise:</h3>
                <p id="option2-premise">Loading...</p>
                <h3>Hypothesis:</h3>
                <p id="option2-hypothesis">Loading...</p>
                <button onclick="showText('option2')">Generate a different premise and hypothesis</button>

            </div>
            <div class="nli-container">
                <h2>Select Your Answer</h2>
                <div class="option" onclick="selectOption(this)">Entailment</div>
                <div class="option" onclick="selectOption(this)">Contradiction</div>
                <div class="option" onclick="selectOption(this)">Neutral</div>
            </div>
            <button id="random-nli" onclick="chooseRandomOption()">Try a Random Response</button>
        </div>
        <div id="option3" class="box hidden">
            <h2>Pairwise Evaluation</h2>
            <p>In this task our evaluator chooses a better answer between two offered ones for a specific question.</p>
            <h3>Question</h3>
            <p id="question">Loading...</p>
            <div class="answer-container">
                <div class="styled-box">
                    <h4>Model 1:</h4><p id="model1">Loading...</p>
                    <h3>Answer 1:</h3>
                    <p id="answer1">Loading...</p>
                </div>
                <div class="styled-box">
                    <h4>Model 2:</h4><p id="model2">Loading...</p>
                    <h3>Answer 2:</h3>
                    <p id="answer2">Loading...</p>
                </div>
            </div>
            <button onclick="showText('option3')">Generate a different question</button>
            <div class="nli-container">
                <h2>Select Your Answer</h2>
                <div class="option2" onclick="selectOption2(this)">Answer 1</div>
                <div class="option2" onclick="selectOption2(this)">Answer 2</div>
            </div>
            <button id="random-nli" onclick="chooseRandomOption2()">Try a Random Response</button>

        </div>
    </main>
</body>
</html>
